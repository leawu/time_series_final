---
title: "Final Project"
output:
  html_document:
    df_print: paged
---
# Final Project - Model 1

```{r results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(forecast)
df <- read.csv("count_check.csv")
```

### **EDA & Data Transformation**

**Data Transformation**: 
- Transform data into 2 sub dataframe, one with yearly aggregation and one with daily aggregation.

```{r}
summary(df)
min(df$Trip.Start.Timestamp)
```

```{r warning=FALSE}
# Convert Trip.Start.Timestamp to DateTime type
df$Trip.Start.Timestamp <- as.POSIXct(df$Trip.Start.Timestamp, format = "%m/%d/%Y")


# Make a new df that only contains YEAR and TOTAL COUNT
yearly_trips <- df %>%
  mutate(Year = year(Trip.Start.Timestamp)) %>%
  group_by(Year) %>%
  summarise(Total_Trips = sum(count))  
print(yearly_trips)

# Plot
ggplot(yearly_trips, aes(x = Year, y = Total_Trips)) +
  geom_histogram(stat = "identity", fill = "gold") +
  labs(title = "Annual Taxi Trip", x = "Year", y = "Total Trips") +
  theme_minimal()
```

#### **Transform data into Daily Taxi Trips dataset**
```{r}
daily_trips <- df %>%
  mutate(Date = as.Date(Trip.Start.Timestamp)) %>%  
  group_by(Date) %>%
  summarise(trips_count = sum(count)) 

daily_trips <- daily_trips[-nrow(daily_trips),]
daily_trips
```

### **SARIMA with weekly seasonality model**
```{r}
# initialize a TS 
daily_ts = ts(daily_trips$trips_count, start=daily_trips$Date[1], frequency = 7)

#acf
acf(daily_ts, lag.max = 100, main="Daily acf", ylab="Autocorrelation")
pacf(daily_ts, lag.max = 100)

#split train and test
daily_ts_train <- daily_ts[
  1:(difftime(as.Date("2023-06-30"), as.Date("2013-01-01"), units = "days")+1)]
daily_ts_train <- ts(daily_ts_train, start=daily_trips$Date[1], frequency = 7)
#establish covid window
covid_window <- difftime(as.Date("2020-03-01"), as.Date("2013-01-01"), units = "days") : 
                (difftime(as.Date("2023-06-30"), as.Date("2013-01-01"), units = "days")+1)
full_window <- 1:(difftime(as.Date("2023-06-30"), as.Date("2013-01-01"), units = "days")+1)
#add dummy variable
covid_intervention <- ifelse(full_window %in% covid_window, 1, 0)
#season length
season_length <- 7 # (since its weekly seasonality)
covid_intervention_adj <- covid_intervention[-(1:season_length)]
#difference the daily TS by 7 (the season length)
daily_ts_diff <- diff(daily_ts_train, season_length)
```

**After all the prep, now I will build a SARIMA model with weekly seasonality using covid intervention as an external regressor**

```{r}
#find an auto.arima model of the differenced of daily_ts using covid_intervention adj
sarima_m = auto.arima(daily_ts_diff, xreg = covid_intervention_adj) 
print("SARIMA Model with weekly seasonality with COVID intervention:")
summary(sarima_m)
```


**Now, fit the sarima in to the test dataset (July 2023 to December 2023)**

In this code block, I did:

- Create a variable for Test data

- Forecast on the Test dataset using sarima model generated above with xreg is an array of 1s because the COVID is a step intervention

- Rescale the forecast to measure accuracy (undo differencing)

```{r}
daily_ts_test <- daily_ts[(length(daily_ts_train)+1):length(daily_ts)]
# Forecast sarima on the test data set
sarima_forecast <- forecast(sarima_m, xreg = rep(1, length(daily_ts_test)))
# Readjust/Un-difference the forecast to to measure accuracy

sarima_forecast_rescale <- sarima_forecast

# Adjust the mean of the first week of the forecast by subtracting the previous week from the original data
sarima_forecast_rescale$mean <- sarima_forecast_rescale$mean + c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length)  )

sarima_forecast_rescale$lower[,"80%"] <- sarima_forecast_rescale$lower[,"80%"] +c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length))

sarima_forecast_rescale$lower[,"95%"] <- sarima_forecast_rescale$lower[,"95%"] +c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length))

sarima_forecast_rescale$upper[,"80%"] <-
  sarima_forecast_rescale$upper[,"80%"] +
  c(
    tail(daily_ts_train, season_length),
    rep(0, length(sarima_forecast_rescale$mean)-season_length)
  )

sarima_forecast_rescale$upper[,"95%"] <-
  sarima_forecast_rescale$upper[,"95%"] +
  c(
    tail(daily_ts_train, season_length),
    rep(0, length(sarima_forecast_rescale$mean)-season_length)
  )

# Adjust all week after the first week of the forecast
# We are doing that because there is no more original data to use for the adjustment so we to use forecast data 

for(h in (season_length+1):length(daily_ts_test)) {
  sarima_forecast_rescale$mean[h] <- 
    sarima_forecast_rescale$mean[h] + sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$lower[,"80%"][h] <- 
    sarima_forecast_rescale$lower[,"80%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$lower[,"95%"][h] <- 
    sarima_forecast_rescale$lower[,"95%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$upper[,"80%"][h] <- 
    sarima_forecast_rescale$upper[,"80%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$upper[,"95%"][h] <- 
    sarima_forecast_rescale$upper[,"95%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
}
```

**Last steps:** Measure accuracy and plot the forecast
```{r}
sarima_accuracy <- accuracy(sarima_forecast_rescale, daily_ts_test)
print(sarima_accuracy)

plot(sarima_forecast_rescale, include = 0, ylab="Trip Count", main = "Daily Taxi Trips Forecast July-December 2023 w/ SARIMA", xaxt="n")

axis(1, at = seq(15780, 15783, length.out = 6), labels = c("Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))

lines(x = time(sarima_forecast$mean), y = daily_trips[-(1:length(daily_ts_train)),]$trips_count, col="gold", lwd=2, type="l")

legend("topleft", legend=c("Actual", "Predicted"), col=c("gold", 4), lty=c(1,1), lwd=2, cex=0.6)
```



## **Experiment with PULSE Intervention:**

```{R}
covid_window <- difftime(as.Date("2020-03-01"), as.Date("2013-01-01"), units = "days") : 
                (difftime(as.Date("2022-06-30"), as.Date("2013-01-01"), units = "days")+1)
full_window <- 1:(difftime(as.Date("2023-06-30"), as.Date("2013-01-01"), units = "days")+1)
#add dummy variable
covid_intervention <- ifelse(full_window %in% covid_window, 1, 0)
#season length
season_length <- 7 # (since its weekly seasonality)
covid_intervention_adj <- covid_intervention[-(1:season_length)]
#difference the daily TS by 7 (the season length)
daily_ts_diff <- diff(daily_ts_train, season_length)

sarima_m = auto.arima(daily_ts_diff, xreg = covid_intervention_adj) 
summary(sarima_m)

daily_ts_test <- daily_ts[(length(daily_ts_train)+1):length(daily_ts)]
# Forecast sarima on the test data set
sarima_forecast <- forecast(sarima_m, xreg = rep(0, length(daily_ts_test)))
# Readjust/Un-difference the forecast to to measure accuracy

sarima_forecast_rescale <- sarima_forecast

# Adjust the mean of the first week of the forecast by subtracting the previous week from the original data
sarima_forecast_rescale$mean <- sarima_forecast_rescale$mean + c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length)  )

sarima_forecast_rescale$lower[,"80%"] <- sarima_forecast_rescale$lower[,"80%"] +c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length))

sarima_forecast_rescale$lower[,"95%"] <- sarima_forecast_rescale$lower[,"95%"] +c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length))

sarima_forecast_rescale$upper[,"80%"] <-
  sarima_forecast_rescale$upper[,"80%"] +
  c(
    tail(daily_ts_train, season_length),
    rep(0, length(sarima_forecast_rescale$mean)-season_length)
  )

sarima_forecast_rescale$upper[,"95%"] <-
  sarima_forecast_rescale$upper[,"95%"] +
  c(
    tail(daily_ts_train, season_length),
    rep(0, length(sarima_forecast_rescale$mean)-season_length)
  )

# Adjust all week after the first week of the forecast
# We are doing that because there is no more original data to use for the adjustment so we to use forecast data 

for(h in (season_length+1):length(daily_ts_test)) {
  sarima_forecast_rescale$mean[h] <- 
    sarima_forecast_rescale$mean[h] + sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$lower[,"80%"][h] <- 
    sarima_forecast_rescale$lower[,"80%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$lower[,"95%"][h] <- 
    sarima_forecast_rescale$lower[,"95%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$upper[,"80%"][h] <- 
    sarima_forecast_rescale$upper[,"80%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$upper[,"95%"][h] <- 
    sarima_forecast_rescale$upper[,"95%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
}

sarima_accuracy <- accuracy(sarima_forecast_rescale, daily_ts_test)
print(sarima_accuracy)
```


## **Pretending that the model does not use COVID intervention**

```{R}
sarima_m <- auto.arima(daily_ts_diff)
summary(sarima_m)

daily_ts_test <- daily_ts[(length(daily_ts_train)+1):length(daily_ts)]
# Forecast sarima on the test data set
sarima_forecast <- forecast(sarima_m, h=length(daily_ts_test))
# Readjust/Un-difference the forecast to to measure accuracy

sarima_forecast_rescale <- sarima_forecast

# Adjust the mean of the first week of the forecast by subtracting the previous week from the original data
sarima_forecast_rescale$mean <- sarima_forecast_rescale$mean + c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length)  )

sarima_forecast_rescale$lower[,"80%"] <- sarima_forecast_rescale$lower[,"80%"] +c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length))

sarima_forecast_rescale$lower[,"95%"] <- sarima_forecast_rescale$lower[,"95%"] +c(tail(daily_ts_train, season_length), rep(0, length(sarima_forecast_rescale$mean)-season_length))

sarima_forecast_rescale$upper[,"80%"] <-
  sarima_forecast_rescale$upper[,"80%"] +
  c(
    tail(daily_ts_train, season_length),
    rep(0, length(sarima_forecast_rescale$mean)-season_length)
  )

sarima_forecast_rescale$upper[,"95%"] <-
  sarima_forecast_rescale$upper[,"95%"] +
  c(
    tail(daily_ts_train, season_length),
    rep(0, length(sarima_forecast_rescale$mean)-season_length)
  )

# Adjust all week after the first week of the forecast
# We are doing that because there is no more original data to use for the adjustment so we to use forecast data 

for(h in (season_length+1):length(daily_ts_test)) {
  sarima_forecast_rescale$mean[h] <- 
    sarima_forecast_rescale$mean[h] + sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$lower[,"80%"][h] <- 
    sarima_forecast_rescale$lower[,"80%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$lower[,"95%"][h] <- 
    sarima_forecast_rescale$lower[,"95%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$upper[,"80%"][h] <- 
    sarima_forecast_rescale$upper[,"80%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
  sarima_forecast_rescale$upper[,"95%"][h] <- 
    sarima_forecast_rescale$upper[,"95%"][h] +
    sarima_forecast_rescale$mean[h-season_length]
}

sarima_accuracy <- accuracy(sarima_forecast_rescale, daily_ts_test)
print(sarima_accuracy)
```


